import numpy as np
import matplotlib.pyplot as plt
from sklearn.cluster import AgglomerativeClustering

# Assuming 'in_data' is provided by the environment (e.g., Orange)
# Convert Orange Table to numpy
X = np.array([list(row) for row in in_data])

def divisive_clustering(X, n_clusters=3):
    """
    Performs divisive clustering by repeatedly splitting the largest cluster.
    """
    clusters = [X]
    while len(clusters) < n_clusters:
        # Find the largest cluster to split
        # Note: This simple 'len' heuristic might not always be the best
        cluster_to_split_idx = np.argmax([len(c) for c in clusters])
        cluster_to_split = clusters.pop(cluster_to_split_idx)

        # Split the cluster into 2 sub-clusters using Agglomerative Clustering
        # We use Agglomerative Clustering here to find two groups within the data
        clustering = AgglomerativeClustering(n_clusters=2)
        
        # Check if cluster is too small to split
        if len(cluster_to_split) < 2:
            clusters.append(cluster_to_split) # Add it back and stop
            break
            
        labels = clustering.fit_predict(cluster_to_split)
        
        sub_cluster_1 = cluster_to_split[labels == 0]
        sub_cluster_2 = cluster_to_split[labels == 1]
        
        # Add the new sub-clusters
        if len(sub_cluster_1) > 0:
            clusters.append(sub_cluster_1)
        if len(sub_cluster_2) > 0:
            clusters.append(sub_cluster_2)
            
    return clusters

# Perform clustering
clusters = divisive_clustering(X, n_clusters=3)

# Visualization
colors = ['red', 'green', 'blue', 'purple', 'orange', 'cyan'] # Added more colors
for i, cluster in enumerate(clusters):
    color = colors[i % len(colors)] # Use modulo for safety
    if cluster.shape[1] >= 2: # Ensure we have at least 2 features to plot
        plt.scatter(cluster[:, 0], cluster[:, 1], c=color, label=f'Cluster {i+1}')
    elif cluster.shape[1] == 1: # Handle 1D data
        plt.scatter(cluster[:, 0], np.zeros_like(cluster[:, 0]), c=color, label=f'Cluster {i+1}')

if X.shape[1] >= 2:
    plt.xlabel('Feature 1')
    plt.ylabel('Feature 2')
elif X.shape[1] == 1:
    plt.xlabel('Feature 1')
    plt.ylabel('') # No y-axis for 1D plot
    
plt.title('Divisive Hierarchical Clustering')
plt.legend()
plt.show()

# Pass original data to output for other widgets
out_data = in_data
